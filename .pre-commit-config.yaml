# See https://pre-commit.com for more information
# See https://pre-commit.com/hooks.html for more hooks

ci:
  autofix_prs: false  # 在 pre-commit.ci 上不要自动往 PR 推“修复” commit
  autofix_commit_msg: "[Lint]: [pre-commit.ci] auto fixes [...]"  # 若启用 autofix 时自动生成的 commit message 模板
  autoupdate_commit_msg: "[CI] [pre-commit.ci] autoupdate"       # pre-commit.ci 自动更新 hook 版本时使用的 commit message
  autoupdate_schedule: monthly  # 每月自动更新一次 hook 版本

# 默认哪些阶段会触发这些 hook
default_stages: [pre-commit, pre-push, manual]

# 全局忽略的目录：build/ 和 3rdparty/ 下的文件不跑任何 hook
exclude: '^(build|3rdparty)/.*$'  # exclude build and 3rdparty directories

repos:
  # 基础通用检查：符号链接、文件大小、合并冲突等
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: check-symlinks            # 检查仓库中的符号链接是否指向有效路径
      - id: destroyed-symlinks        # 检查是否有被误破坏的符号链接（例如原来是 symlink 现在变成普通文件）
      # FIXME: enable these hooks
      # - id: trailing-whitespace     # 检查并清理行尾多余空格（目前暂未启用）
      # - id: end-of-file-fixer      # 确保文件末尾有且仅有一个换行符（目前暂未启用）
      - id: check-added-large-files   # 阻止一次性添加过大的文件，避免仓库变得臃肿
      - id: check-merge-conflict      # 检查是否存在 Git 合并冲突标记 <<<<<<< / ======= / >>>>>>>
        fail_fast: true               # 一旦发现冲突标记立即失败
      # FIXME: enable these hooks
      # - id: check-executables-have-shebangs        # 检查可执行文件是否带 shebang（未启用）
      # - id: check-shebang-scripts-are-executable   # 检查带 shebang 的脚本是否为可执行文件（未启用）
      - id: detect-private-key        # 检测是否误把私钥文件提交到仓库（例如 SSH/TLS 私钥）
      - id: check-yaml                # 校验所有 YAML 文件的语法是否正确
      - id: check-toml                # 校验 TOML 文件（如 pyproject.toml）语法是否正确
      - id: check-ast                 # 对 Python 文件做 AST 解析，检查语法错误
        fail_fast: true               # 一旦发现语法错误立即失败
      - id: debug-statements          # 检测 Python 中的调试语句，如 pdb.set_trace()/breakpoint()
      - id: file-contents-sorter      # 对指定文件中的内容按行排序，这里用于 spelling_wordlist
        args: [--ignore-case]         # 排序时忽略大小写
        files: ^docs/spelling_wordlist\.txt$  # 仅作用于 docs/spelling_wordlist.txt

  # 使用 Ruff 做 Python 代码静态检查 / Lint
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.3  # sync with requirements-lint.txt
    hooks:
      - id: ruff-check
        # 自动修复可修复的问题，并在有修复时返回非 0 退出码，提醒重新 git add
        args: [--fix, --exit-non-zero-on-fix]

  # 使用 yapf 做 Python 代码格式化
  - repo: https://github.com/google/yapf
    rev: v0.43.0  # sync with requirements-lint.txt
    hooks:
      - id: yapf
        name: yapf-multiproc-bugfix
        # yapf 不是多进程安全，这里先对 docs/conf.py 跑一个“dummy” yapf
        # 起到预热/规避并发 bug 的效果
        args: [--in-place, docs/conf.py]
        always_run: true    # 每次都运行，与文件改动无关
        pass_filenames: false  # 不根据文件列表传参，而是只作用于 docs/conf.py
      - id: yapf
        # 真正的全局 Python 格式化：递归地对仓库里的 Python 文件做就地格式化
        args: [--recursive, --in-place]

  # 使用 codespell 做英文拼写检查
  - repo: https://github.com/codespell-project/codespell
    rev: v2.4.1  # sync with requirements-lint.txt
    hooks:
      - id: codespell
        # 让 codespell 能够从 pyproject.toml / setup.cfg 等读取配置
        additional_dependencies: [".[toml]"]
        # 排除不适合做拼写检查的文件类型，例如 C/C++/CUDA 源码、SVG、requirements 列表等
        exclude: |
          (?x)(
            ^.+\.(cpp|hpp|cxx|cc|c|h|cu|cuh)$|
            ^.+\.svg$|
            ^.*\brequirements\b.*\.txt$
          )
